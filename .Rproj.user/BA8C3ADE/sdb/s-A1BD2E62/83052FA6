{
    "collab_server" : "",
    "contents" : "library(leaflet)\nlibrary(rgdal)\nlibrary(rgeos)\nlibrary(scales)\nlibrary(jsonlite)\nlibrary(httr)\nlibrary(noncensus)\nlibrary(htmltools)\n\n# Get the data (need to put your BEA_API_TOKEN in .Renviron ---------------\n\nresponse <- GET(\"http://bea.gov/api/data/\",\n                query=list(\n                  UserID=Sys.getenv(\"BEA_API_TOKEN\"),\n                  method=\"GetData\",\n                  datasetname=\"RegionalData\",\n                  KeyCode=\"RPPALL_MI\",\n                  Year=\"2013\",\n                  ResultFormat=\"json\"\n                ))\ndat <- fromJSON(content(response, as=\"text\"))\ndat <- dat$BEAAPI$Results$Data\ndat$X2013 <- as.numeric(dat$DataValue)\n\n# Cleanup the data a bit --------------------------------------------------\n\ndat$GeoName <- gsub(\" \\\\(Metropolitan Statistical Area\\\\)\", \"\", dat$GeoName)\ndat$GeoFips <- sprintf(\"%05d\", as.numeric(dat$GeoFips))\n\n# We need to translate census county codes to FIPS for the map ------------\n\ndata(counties)\nxlate <- data.frame(fipscounty=sprintf(\"%s%s\", counties$state_fips,\n                                       counties$county_fips),\n                    cbsa=counties$CBSA,\n                    stringsAsFactors=FALSE)\ndat <- merge(dat[,c(1,2,8)], xlate[,c(\"cbsa\", \"fipscounty\")],\n             by.x=\"GeoFips\", by.y=\"cbsa\")\n\n# Use existing TopoJSON map files -----------------------------------------\n\nURL <- \"http://bl.ocks.org/mbostock/raw/4090846/us.json\"\nfil <- basename(URL)\nif (!file.exists(fil)) download.file(URL, fil)\n\nstates <- readOGR(fil, \"states\", stringsAsFactors=FALSE)\ncounty <- readOGR(fil, \"counties\", stringsAsFactors=FALSE)\n\nrpp_counties <- subset(county, id %in% dat$fipscounty)\nrpp_counties <- merge(rpp_counties, dat, by.x=\"id\", by.y=\"fipscounty\", all.x=TRUE)\n\n# Setup color scale -------------------------------------------------------\n\npal <- colorBin(\"BrBG\", range(rpp_counties$X2013), bins=5)\nrpp_counties$color <- pal(rpp_counties$X2013)\n\n# make the map ------------------------------------------------------------\n\nleaflet() %>%\n  addProviderTiles(\"Acetate.terrain\") %>%\n  addPolygons(data=rpp_counties, weight=0.25,\n              fillColor=~color, color=\"black\", fillOpacity=1,\n              popup=~sprintf(\"In %s, <span style='font-weight:700'>%s</span> has the purchasing power of $100.00.\",\n                             htmlEscape(GeoName),\n                             htmlEscape(dollar(X2013)))) %>%\n  addPolygons(data=states, weight=0.5, fillColor=\"white\", fillOpacity=0, fill=FALSE, color=\"#525252\") %>%\n  addLegend(position=\"bottomright\", pal=pal, values=rpp_counties$X2013, labFormat=labelFormat(\"$\"), opacity = 1) %>%\n  setView(-74.0059, 40.7127, 6)\n",
    "created" : 1443202307702.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1917029457",
    "id" : "83052FA6",
    "lastKnownWriteTime" : 1443206881,
    "path" : "~/Development/graphical_web_2015/rpp.R",
    "project_path" : "rpp.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}